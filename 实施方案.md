# CelerIM C++ 后端实施方案

## 1. 项目背景与目标
- **背景**：当前仓库 `CIM` 已具备基础的网络、协程、日志等通用组件，需要在此基础上实现 CelerIM 的完整后端能力，与前端在 `接口清单.md`、`types.d.ts` 定义的契约保持一致。
- **总体目标**：交付一个可部署、可扩展的 IM 后端，包括 RESTful API、WebSocket 服务、数据库与缓存支撑、自动化测试与运维体系。
- **最终交付**：
  1. 覆盖全部接口契约的可执行服务（含 Docker 镜像）。
  2. 完整的数据模型、迁移脚本与初始化数据。
  3. CI/CD、监控、运维文档。

## 2. 技术选型
- **语言与标准**：C++20（与现有库保持一致）。
- **网络/框架**：基于仓库现有 I/O、协程能力构建 HTTP & WebSocket 服务；若需快速落地可集成 `drogon` 作为 HTTP/WebSocket 层，复用仓库基础设施。
- **JSON/YAML**：`nlohmann/json` 处理 JSON，`yaml-cpp` 处理配置。
- **数据库**：首选 PostgreSQL（支持 JSONB、并发性能好）；兼容 MySQL 作为备选。
- **ORM/DAO**：封装仓库内的 DB 模块，提供 DAO 层；必要时集成 `sqlpp11` 以提高类型安全。
- **缓存**：Redis（连接池、发布订阅、分布式锁）。
- **日志与观测**：继续使用项目 `log` 模块，追加 Prometheus exporter、OpenTelemetry（可选）。
- **测试**：`googletest` + `gmock`，接口测试使用 `pytest` + `httpx`（Python）或 `drogon_ctl test`。

## 3. 整体架构设计
- **分层架构**：
  - API 层（HTTP Controllers + WebSocket handlers）：参数校验、鉴权、异常映射。
  - Service 层：业务逻辑、事务控制、幂等、缓存策略。
  - Repository/DAO 层：数据库 CRUD、查询优化、批量操作。
  - Common 模块：配置、日志、错误码、工具集、TaskQueue。
  - Cache 模块：Redis 读写、键模型、分布式锁、消息订阅。
  - Task 模块：异步任务（文件处理、通知推送）。
  - Integration：外部服务（短信、邮件、OAuth）。
- **交互流程**：
  1. 前端经 `/api/v1/*` 调用 HTTP 接口。
  2. Gateway（可选）将请求路由到 API 层。
  3. API 层解析请求体（参照 `types.d.ts`），并委派 Service 层。
  4. Service 层调用 DAO、Cache、Task，返回统一响应结构。
  5. 长连接通过 WebSocket，服务端维护连接表，推送消息与事件。

## 4. 项目结构设计
结合现有仓库结构，新增/调整如下（仅列关键目录）：
```
CIM/
├─ CMakeLists.txt
├─ autobuild.sh
├─ config/
│  ├─ log.yaml
│  ├─ server.yaml
│  ├─ system.yaml
│  └─ workers.yaml
├─ include/
│  ├─ api/                 # HTTP & WebSocket 控制器头文件
│  ├─ app/                 # Service 层接口
│  ├─ dao/                 # DAO 接口定义
│  ├─ dto/                 # DTO/VO 定义，映射 types.d.ts
│  ├─ middleware/          # 鉴权、限流、异常处理
│  ├─ infra/               # Redis、DB、TaskQueue 封装
│  └─ common/              # Config、ErrorCode、Utils
├─ src/
│  ├─ api/                 # 控制器实现
│  ├─ app/                 # Service 实现
│  ├─ dao/                 # DAO 实现
│  ├─ dto/                 # DTO ↔ Domain 映射
│  ├─ infra/
│  │  ├─ db/
│  │  ├─ redis/
│  │  └─ mq/
│  └─ bootstrap/           # Server 启动、路由注册
├─ migrations/             # SQL/迁移脚本
├─ scripts/
│  ├─ docker/
│  ├─ sql/
│  └─ tooling/
├─ tests/
│  ├─ unit/
│  ├─ integration/
│  └─ perf/
└─ docs/
   ├─ api/
   ├─ db/
   └─ ops/
```
> 保留现有 `include/base`, `src/base` 等基础模块，新增子目录并通过命名空间区分业务与基础设施。

## 5. 构建与依赖管理
- 在根 `CMakeLists.txt` 中新增 FetchContent/ExternalProject 引入第三方库（Redis client、JWT、bcrypt）。
- 模块化 CMake：`add_subdirectory(src/api)` 等，启用 `target_link_libraries` 组织依赖。
- 提供 `autobuild.sh` 扩展参数（如 `--with-tests`）。
- 集成 `clang-format`, `clang-tidy` 任务。

## 6. 数据库设计
### 6.1 总体说明
- **命名约定**：下划线命名、全部小写。
- **字段类型**：
  - 主键：`bigserial/bigint`
  - 时间：`timestamptz`
  - 枚举：`smallint` 或 PostgreSQL `enum`
  - JSON 数据：`jsonb`
- **公共字段**：`created_at`, `updated_at`, `deleted_at`（软删）

### 6.2 用户与鉴权
| 表 | 说明 |
| --- | --- |
| `users` | 用户基础信息 |
| `user_tokens` | Token 管理（JWT 黑名单或多终端登陆）|
| `user_profiles` | 扩展资料（座右铭、生日等）|

**users**
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | bigserial PK | 用户ID |
| mobile | varchar(20) unique | 登录手机号 |
| email | varchar(128) unique | 邮箱 |
| password_hash | varchar(255) | bcrypt hash |
| nickname | varchar(64) | 昵称 |
| avatar | varchar(255) | 头像地址 |
| gender | smallint | 0未知/1男/2女 |
| motto | varchar(255) | 座右铭 |
| status | smallint | 1正常/0禁用 |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

**user_tokens**
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| id | bigserial PK |
| user_id | bigint FK users(id) |
| access_token | varchar(512) | 当前 token |
| platform | varchar(32) | 客户端平台 |
| expires_at | timestamptz | 过期时间 |
| created_at | timestamptz |
| revoked_at | timestamptz nullable |
| metadata | jsonb | 设备信息、IP |
> 对应 `AuthLoginResponse`, `AuthRegisterResponse`, `AuthOauth*` 契约。

### 6.3 联系人与好友
| 表 | 说明 |
| --- | --- |
| `contact_groups` | 自定义分组 |
| `contacts` | 好友关系 |
| `contact_applies` | 好友申请 |

**contact_groups**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| user_id | bigint FK users(id) |
| name | varchar(32) |
| sort | int |
| created_at | timestamptz |
| updated_at | timestamptz |

**contacts**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| user_id | bigint | 拥有者 |
| friend_id | bigint | 好友 |
| group_id | bigint FK contact_groups(id) |
| remark | varchar(64) |
| created_at | timestamptz |
| updated_at | timestamptz |
| deleted_at | timestamptz |
| relation | smallint | 关系状态（1有效、0拉黑）|

**contact_applies**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| user_id | bigint | 发起者 |
| friend_id | bigint | 目标 |
| remark | varchar(128) |
| status | smallint | 0待处理/1接受/2拒绝 |
| created_at | timestamptz |
| updated_at | timestamptz |
| handled_at | timestamptz |

### 6.4 组织架构
| 表 | 说明 |
| --- | --- |
| `departments` | 企业通讯录部门 |
| `department_members` | 部门成员关联 |
| `positions` | 职位列表 |
| `user_positions` | 用户职位关联 |

### 6.5 会话与消息
| 表 | 说明 |
| --- | --- |
| `talk_sessions` | 会话列表 |
| `talk_session_members` | 会话成员（含免打扰、置顶状态）|
| `messages` | 消息主表 |
| `message_extra` | JSON 扩展属性 |
| `message_ack` | ACK 跟踪 |
| `message_forward` | 转发记录 |

**talk_sessions**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| talk_mode | smallint | 1私聊/2群聊 |
| owner_id | bigint | 会话归属用户（列表视图）|
| to_from_id | bigint | 私聊对方ID或群ID |
| is_top | boolean |
| is_disturb | boolean |
| last_msg_id | bigint FK messages(id) |
| unread_num | int |
| updated_at | timestamptz |

**messages**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| talk_mode | smallint |
| session_id | bigint |
| msg_id | varchar(64) unique | 全局唯一 ID |
| sequence | bigint | 递增序列 |
| from_id | bigint |
| to_from_id | bigint |
| msg_type | smallint |
| body | jsonb | 消息体（文本、图片、文件等）|
| quote | jsonb | 引用信息 |
| is_revoked | boolean |
| send_time | timestamptz |
| created_at | timestamptz |

**message_extra**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| message_id | bigint FK messages(id) |
| extra | jsonb |
| created_at | timestamptz |

**message_ack**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| msg_id | varchar(64) |
| user_id | bigint |
| ack_status | smallint | 0待确认/1已确认/2失败 |
| ack_time | timestamptz |
| retry_count | smallint |

### 6.6 群组
| 表 | 说明 |
| --- | --- |
| `groups` | 群基础信息 |
| `group_members` | 群成员 |
| `group_notices` | 群公告 |
| `group_applies` | 入群申请 |
| `group_votes` | 群投票 |
| `group_vote_options` | 投票选项 |
| `group_vote_records` | 投票记录 |

**groups**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| name | varchar(64) |
| avatar | varchar(255) |
| profile | varchar(255) |
| owner_id | bigint |
| creator_id | bigint |
| type | smallint | 普通/公开 |
| is_mute | boolean |
| is_overt | boolean |
| max_num | int |
| created_at | timestamptz |
| updated_at | timestamptz |

**group_members**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| group_id | bigint |
| user_id | bigint |
| nickname | varchar(64) |
| remark | varchar(64) |
| leader | smallint | 0成员/1管理员/2群主 |
| is_mute | boolean |
| join_time | timestamptz |
| last_read_seq | bigint |

### 6.7 文章 / 笔记
| 表 | 说明 |
| --- | --- |
| `article_categories` | 分类 |
| `articles` | 文章主表 |
| `article_tags` | 标签 |
| `article_tag_relations` | 文章-标签关联 |
| `article_annex` | 附件 |
| `article_recycle_bin` | 软删除记录（可合并到主表 `deleted_at`）|

**articles**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| user_id | bigint |
| classify_id | bigint |
| title | varchar(128) |
| abstract | varchar(512) |
| md_content | text |
| status | smallint | 正常/草稿/删除 |
| is_asterisk | boolean |
| created_at | timestamptz |
| updated_at | timestamptz |
| deleted_at | timestamptz |

**article_annex**
| 字段 | 类型 | 说明 |
| id | bigserial PK |
| article_id | bigint |
| annex_name | varchar(128) |
| storage_path | varchar(255) |
| file_size | bigint |
| mime_type | varchar(64) |
| status | smallint | 正常/回收站/删除 |
| created_at | timestamptz |
| deleted_at | timestamptz |

### 6.8 索引与优化
- 常用查询添加 B-tree 索引：`contacts(user_id, friend_id)`, `messages(session_id, sequence)`, `group_members(group_id, user_id)`。
- 需要模糊搜索的列（如 nickname、title）可添加 `GIN` 全文索引。
- Redis 缓存：
  - Key：`session:unread:<user_id>:<session_id>`
  - Key：`user:online:<user_id>`
  - Key：`group:members:<group_id>`（集合）
  - 消息推送队列：`stream:message` 使用 Redis Stream。

### 6.9 数据迁移与管理
- 使用 `migrations/` 存放 SQL；提供 `scripts/sql/migrate.sh`。
- 集成 Flyway 或自定义迁移工具（C++ 调用 SQL 脚本）。
- 初始化脚本：创建管理员账号、默认分类、系统通知模板。

## 7. 业务模块实施细化
### 7.1 鉴权模块
- 登录、注册、忘记密码、OAuth 接口。
- 支持短信/邮件验证码（与外部服务集成）。
- JWT 签发 + Redis 缓存黑名单，接口统一校验。

### 7.2 用户资料
- `UserDetail*` 接口映射 `users + user_profiles`。
- 敏感信息修改需校验密码或验证码。
- 缓存策略：用户资料写 Redis，更新时失效。

### 7.3 联系人/企业通讯录
- 好友申请流：申请 → 同意/拒绝 → 好友关系建立。
- 未读数通过 Redis 维护，定时落库。
- 企业通讯录从 `departments`、`department_members` 读取，支持分页和缓存。

### 7.4 会话与消息
- 会话创建：检查是否已存在，若无则创建 session + 默认状态。
- 消息写入流程：
  1. 校验 talk_mode 与权限。
  2. 插入 `messages`，生成全局 `sequence`（per session）。
  3. 分发到 WebSocket 链接；异步写入 Redis Stream。
  4. 更新会话 `unread_num`、最近消息。
- 历史记录分页：游标基于 sequence，支持向前翻页。
- 消息撤回：设置 `is_revoked`，推送 `im.message.revoke` 事件。

### 7.5 WebSocket
- 连接 URI：`${VITE_SOCKET_API}/wss/default.io?token=<JWT>`。
- 握手：校验 token → 加载用户信息 → 加入 Redis 哈希 `ws:connections`。
- 心跳：处理 `ping/pong`，超时断开。
- 消息推送：
  - 私聊：投递给在线的目标用户，多端同步。
  - 群聊：遍历群成员连接表，异步发送。
  - ACK：收到 `event=ack` 更新 `message_ack`。
- 重连：支持 `resume_ticket`（可选），重新同步未 ack 消息。

### 7.6 群组与投票
- 群管理接口与权限：群主、管理员动作分别鉴权。
- 公告、禁言、公开群等字段映射 `groups` 表。
- 投票：写入 `group_votes` + `group_vote_options`，成员提交时写 `group_vote_records`。

### 7.7 笔记/文章
- CRUD 对应 `articles`、`article_categories`、`article_annex`。
- 标签使用多对多关系表 `article_tag_relations`。
- 回收站：`deleted_at` + 状态字段区分。
- 附件：存储至对象存储（MinIO），数据库保留元数据。

### 7.8 自定义表情
- `emoticons` 表：`id`, `user_id`, `url`, `created_at`。
- Redis 缓存列表，更新时广播失效。

## 8. 鉴权与安全策略
- **认证**：HTTP Bearer Token + WebSocket token。
- **权限**：基于用户角色（普通/企业/管理员），在 Service 层校验。
- **限流**：Nginx/Envoy 前置限流 + 应用层 Redis 令牌桶（短信、邮件、申请）。
- **数据加密**：密码存储使用 bcrypt；敏感字段（如手机号）提供脱敏接口。
- **日志审计**：登录、关键操作写入 `operation_logs`。
- **防重放**：接口提供 `request_id` 或 `Idempotency-Key`，消息提供 `ackid`。

## 9. 配置与环境管理
- `config/server.yaml` 定义数据库、Redis、HTTP 端口、线程池。
- 配置分环境：`config/{dev,test,stage,prod}/`。
- 支持环境变量覆盖关键项（同 Docker/K8s）。
- 可选引入 Consul/etcd 做动态配置。

## 10. 部署与运维
- **容器化**：`Dockerfile` 基于 `ubuntu:22.04` + `clang`；`docker-compose` 启动服务、PostgreSQL、Redis、MinIO。
- **CI/CD**：GitHub Actions；流水线包含 build、unit test、integration test、镜像推送。
- **监控与告警**：Prometheus + Grafana；关键指标 QPS、延迟、WS 在线数、DB 连接数。
- **日志**：输出到 stdout，使用 Fluent Bit 或 Filebeat 收集。
- **故障排查**：提供脚本收集 core dump、日志、指标快照。

## 11. 里程碑与任务细化
沿用《开发计划书.md》里程碑，并细化关键动作：
- **M1 基础设施**：完成框架 PoC、搭建目录、配置 CMake、编写第一套单元测试。
- **M2 鉴权模块**：落地用户/认证数据库结构、实现 JWT、完善接口测试。
- **M3 会话消息**：实现消息全链路、WebSocket、Redis 推送、ACK 机制。
- **M4 联系人与群组**：完成好友、群组业务，联调未读数与状态同步。
- **M5 笔记/资源**：完成文章、分类、附件服务，MinIO 集成。
- **M6 安全优化发布**：压测、性能优化、安全加固、运维文档。

每个 Milestone 输出：设计评审纪要、代码/测试报告、部署包。

## 12. 测试策略
- **单元测试**：Service & DAO 层，目标覆盖率 ≥70%。
- **集成测试**：REST + WebSocket 合同测试，对照 `types.d.ts` 请求/响应。
- **性能测试**：使用 `wrk`/`hey` 对 HTTP，`thor` 对 WebSocket。
- **安全测试**：SQL/XSS 注入脚本、Token 篡改、接口限流、ACL 校验。
- **回归测试**：每个里程碑完成后执行全量接口测试套件。

## 13. 风险与缓解
| 风险 | 描述 | 缓解 |
| --- | --- | --- |
| 框架二次开发复杂度 | 需在现有基础上扩展 HTTP/WS | 先完成 PoC，若自研成本高则选型 drogon/crow |
| 数据一致性 | 消息与未读数、ACK 不一致 | 设计事务 + 补偿任务，消息落地优先，Redis 定期校验 |
| 性能瓶颈 | WS 并发、DB 压力 | 水平扩展、多机部署、读写分离、Redis 分片 |
| 安全合规 | Token 泄露 | 强化密钥管理、加密传输、定期轮换密钥 |

## 14. 下一步行动
1. 与团队确认技术选型（框架、数据库、缓存方案）。
2. 编写数据库 ER 图，补充 `docs/db/`。
3. 按 M1 目标初始化项目骨架与 CI。
4. 制定编码规范、错误码表、日志格式。
5. 启动鉴权模块开发，形成最小可用产品。
