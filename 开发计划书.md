# LumenIM C++ 后端开发计划书

## 一、项目概述
- **项目名称**：LumenIM 后端重构
- **技术栈**：
  - 主语言：C++20（推荐）
  - 架构：基于协程的高性能事件驱动模型（如 `asio`/`boost::asio` 或 `libuv`），支持多线程。
  - 框架候选：
    - HTTP/WebSocket：`oatpp`、`drogon`、`pistache`、`crow`、`restinio` 等。
    - 数据库 ORM：`soci`、`oatpp ORM`、`sqlpp11`、自定义封装。
    - 序列化/配置：`nlohmann/json`、`yaml-cpp`。
    - 日志：`spdlog`、`glog`、`log4cplus`。
    - 消息中间件：可选 `Redis`、`Kafka`。
  - 数据库：PostgreSQL / MySQL（选定后统一），配合 Redis 做缓存。

- **目标**：实现与现有前端接口 (`接口清单.md`) 对应的 RESTful API 与 WebSocket 服务，实现 IM 核心业务、联系人管理、群组、笔记、富文本等功能。
- **交付物**：
  1. 可部署的后端服务（含 Docker 镜像）。
  2. 完整接口实现及自动化测试。
  3. 系统文档：架构设计、部署文档、运维手册。

## 二、里程碑拆解

### M1：项目启动 & 基础设施（第 1-2 周）
- 明确技术选型与数据库方案，完成 PoC。
- 建立仓库结构：
  ```
  backend/
    src/
    include/
    tests/
    scripts/
    config/
    CMakeLists.txt
  ```
- 配置 CMake 构建系统，引入基础依赖（HTTP 框架、JSON、日志等）。
- 搭建开发容器/Docker Compose，集成数据库与 Redis。
- 编写基础工具库：配置加载、响应封装、错误码体系。

**交付物**：技术选型报告、初始项目骨架、构建通过。

### M2：基础模块 & 鉴权（第 3-4 周）
- 实现公共模块：
  - 配置中心（多环境 YAML/JSON）
  - 日志与Trace（OpenTelemetry 可选）
  - 数据库访问层（连接池、DAO 模式）
  - 缓存服务封装
- 鉴权模块：JWT 或自定义 Token，登录登出流程。
- 实现 `接口清单.md` 中认证类接口。
- 单元测试覆盖认证逻辑，集成API测试。

**交付物**：用户/认证接口可用，CI 流程运行。

### M3：消息会话核心（第 5-7 周）
- 数据建模：用户、联系人、会话、消息、群组等表结构设计并迁移。
- 实现会话管理接口：创建、列表、置顶、免打扰、未读数。
- WebSocket 服务：
  - Token 鉴权、连接管理、心跳。
  - 消息推送、ACK 机制、重试策略。
  - 事件分发（好友申请、群申请）。
- 消息存储：文本、图片、文件、系统通知等元信息入库。
- 实现消息相关 REST 接口（历史记录、删除、撤回、转发）。
- 引入异步任务队列处理耗时操作（如文件转码、通知）。

**交付物**：核心聊天功能端到端打通，WebSocket 稳定运行。

### M4：联系人 & 群组模块（第 8-10 周）
- 联系人申请流程：创建、受理、未读数、备注、分组。
- 群组管理：
  - 群创建/解散、成员管理、禁言/免打扰、邀请、公开群。
  - 群申请/审核、群公告。
  - 群投票模块（创建/详情/提交）。
- 企业通讯录：部门、人员接口，支持分页/搜索。
- Redis 缓存优化，如联系人在线状态、未读数。

**交付物**：联系人、群组相关接口全部完成，性能初步验证。

### M5：笔记/文章模块与资源服务（第 11-12 周）
- 实现文章、分类、附件的 CRUD 与回收站功能。
- 文件上传/下载服务：
  - 支持大文件分片，存储至对象存储（MinIO/S3）或服务器。
  - 附件管理接口联动。
- 自定义表情管理接口。
- 富文本内容安全过滤。

**交付物**：笔记及附件管理功能完成。

### M6：安全 & 优化 & 发布（第 13-14 周）
- 压测与调优：
  - WebSocket QPS、消息延迟、数据库负载。
  - 关键接口性能指标（p95/p99）。
- 安全加固：
  - SQL 注入、XSS、CSRF、防重放。
  - 鉴权权限校验、敏感信息脱敏。
- 灰度发布策略、配置热更新。
- 编写部署文档、运维手册、故障排查指南。
- 交付最终版本并完成验收。

## 三、架构设计要点

### 1. 组件划分
- **API 层**：HTTP 控制器与 WebSocket 处理器。
- **Service 层**：业务逻辑封装，含事务管理。
- **Repository/DAO 层**：数据库访问，使用 Prepared Statement，避免注入。
- **Common 模块**：配置、日志、异常、错误码、工具库。
- **Task 模块**：异步任务、消息队列处理。
- **Cache 模块**：Redis 接入，处理缓存、分布式锁。

### 2. 数据模型
- 用户表：`users`
- 认证表：`user_tokens`
- 联系人：`contacts`、`contact_groups`
- 会话：`talk_sessions`
- 消息：`messages`（主表）、`message_extra`（扩展属性）
- 群组：`groups`、`group_members`、`group_applies`、`group_votes`
- 文章：`articles`、`article_categories`、`article_annex`
- 日志：`operation_logs`

### 3. WebSocket 流程
1. 前端携带 Token 建立连接 => 鉴权。
2. 服务端维护连接表（可用 Redis/内存+一致性哈希）。
3. 心跳 `ping/pong`，超时断开。
4. 消息到达：
   - 写入消息表。
   - 推送目标用户/群成员。
   - 发送 `ackid`，等待客户端 ACK，未收到时重发或记录失败。
5. 系统事件（好友申请等）通过 WebSocket 推送。

### 4. 关键设计
- **事务与一致性**：会话创建与消息写入需原子性；必要时使用分布式事务或最终一致方案。
- **幂等控制**：WebSocket 与 REST 提供 `request_id` 或 `ackid`，避免重复发送。
- **扩展性**：模块化设计，便于未来接入 AI 辅助、音视频会议。
- **监控**：集成 Prometheus 指标、健康检查、日志聚合。

## 四、开发规范
- 采用 Git Flow；每个模块独立分支开发，提交遵循 Conventional Commits。
- 代码格式化：`clang-format`，静态分析：`clang-tidy`。
- 单元测试框架：`googletest` 或 `Catch2`，覆盖率目标 ≥70%。
- API 文档：使用 OpenAPI/Swagger 自动生成，保持与前端一致。
- CI/CD：GitHub Actions/GitLab CI，自动构建、测试、镜像发布。

## 五、测试策略
- **单元测试**：Service、Repository、工具类。
- **集成测试**：REST API + WebSocket 合同测试。
- **性能测试**：使用 `wrk`/`hey`/`locust`；WebSocket 压测可用 `thor`、自研脚本。
- **安全测试**：SQL/XSS 模拟、鉴权绕过、暴力破解。
- **回归测试**：在每个里程碑完成后执行，保证稳定性。

## 六、部署与运维
- 环境：Dev、Test、Stage、Prod 四套。
- 构建：Docker 镜像包含服务及依赖 DLL/so；使用 `docker-compose` 或 `k8s` 部署。
- 配置管理：环境变量 + 配置中心（Consul/etcd）可选。
- 日志：输出到标准输出 + ELK 收集。
- 监控指标：
  - QPS、响应时间、错误率。
  - WebSocket 在线数、消息堆积。
  - 数据库连接、缓存命中率。
- 告警：Prometheus + Alertmanager，当关键指标阈值触发。

## 七、风险与应对
| 风险 | 描述 | 应对措施 |
| --- | --- | --- |
| 新框架学习成本高 | C++ Web 框架生态小 | 前期 PoC，多做 Demo，必要时选用成熟框架（如 drogon） |
| WebSocket 并发压力 | 高频消息导致性能瓶颈 | 采用高效 IO 库、负载均衡、分布式连接表 |
| 数据一致性 | 消息与未读数不同步 | 设计清晰的事务/补偿机制，使用事件溯源 |
| 开发周期压力 | 功能多、模块复杂 | 明确优先级，关键路径提前实现，增量交付 |
| 安全问题 | Token 泄露、接口滥用 | 强化鉴权、加密传输、全链路审计 |

## 八、人员与分工
- **后端架构师**：框架选型、总体设计、核心模块评审。
- **后端开发 x2-3**：按照模块负责（认证、消息、群组、笔记）。
- **测试工程师**：测试计划、自动化脚本、性能测试。
- **运维工程师**：CI/CD、部署脚本、监控。

## 九、时间规划总览
| 阶段 | 时间 | 负责人 |
| --- | --- | --- |
| M1 | 1-2 周 | 架构师 + 开发 |
| M2 | 3-4 周 | 开发 A |
| M3 | 5-7 周 | 开发 A/B |
| M4 | 8-10 周 | 开发 B/C |
| M5 | 11-12 周 | 开发 C |
| M6 | 13-14 周 | 全体 |

## 十、后续扩展建议
- 接入分布式消息队列，支持消息漫游、离线同步。
- 提供开放 API/SDK，方便第三方接入。
- 支持端到端加密与审计合规。
- 结合 AI 能力（消息摘要、智能客服）。

---
本计划书覆盖从项目启动、架构设计、里程碑、测试到运维的全流程，建议在执行过程中定期评审进度并灵活调整，以确保按期交付高质量的 C++ 后端服务。